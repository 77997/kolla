name: Publish ppc64le Dependencies

on:
  workflow_dispatch:

env:
  PROXYSQL_VERSION: 'v2.7.1'
  GRPCIO_VERSION: '1.74.0'
  CRYPTOGRAPHY_VERSION: '43.0.3'
  BCRYPT_VERSION: '4.0.1'
  OPFLEX_VERSION: '6.1.1.6'
  OVS_VERSION: '3.5.0'
  OPENSEARCH_VERSION: '2.18.0'
  LEGO_VERSION: 'v4.27.0'
  CADVISOR_VERSION: 'v0.53.0'
  OPENSTACK_EXPORTER_VERSION: 'v1.7.0'
  MTAIL_VERSION: 'v3.0.8'
  LIBVIRT_EXPORTER_VERSION: 'v2.2.0'
  FLUENT_PACKAGE_VERSION: 'v6.0.1'
  PILLOW_VERSION: '11.3.0'
  PYRADIX_VERSION: '1.1.0'
  PYYAML_VERSION: '6.0.2'
  MARKUPSAFE_VERSION: '3.0.2'
  MSGPACK_VERSION: '1.1.1'
  WRAPT_VERSION: '1.17.2'
  PSUTIL_VERSION: '7.0.0'
  PYRSISTENT_VERSION: '0.20.0'
  NETIFACES_VERSION: '0.11.0'
  PYNACL_VERSION: '1.5.0'
  UWSGI_VERSION: '2.0.31'
  PROTON_VERSION: '0.40.0'
  PSYCOPG2_VERSION: '2.9.10'
  SYSV_IPC_VERSION: '1.1.0'
  TORNADO_VERSION: '6.5.1'
  UJSON_VERSION: '5.10.0'
  NUMPY_VERSION: '2.2.6'
  LIBSASS_VERSION: '0.23.0'
  ZSTD_VERSION: '1.5.7.2'
  LZ4_VERSION: '4.4.5'
  PYZMQ_VERSION: '27.0.0'
  RUAMEL_YAML_CLIB_VERSION: '0.2.12'
  YAPPI_VERSION: '1.6.10'
  GSSAPI_VERSION: '1.9.0'
  KRB5_VERSION: '0.7.1'
  PYTHON_LDAP_VERSION: '3.4.4'
  SCRYPT_VERSION: '0.8.27'
  RCSSMIN_VERSION: '1.1.2'
  RJSMIN_VERSION: '1.2.2'
  ZEROCONF_VERSION: '0.147.0'
  MAGNUM_CLUSTER_API_VERSION: '0.35.0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-proxysql:
    runs-on: ubuntu-latest
    steps:
      - name: Cache ProxySQL deb
        id: cache
        uses: actions/cache@v4
        with:
          path: proxysql-deb
          key: proxysql-ppc64le-${{ env.PROXYSQL_VERSION }}-deb

      - name: Set up QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/ppc64le

      - name: Build ProxySQL for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p proxysql-deb
          docker run --rm --platform linux/ppc64le \
            -v "${{ github.workspace }}/proxysql-deb:/output" \
            debian:trixie \
            bash -c '
              set -ex
              apt-get update && apt-get install -y --no-install-recommends \
                build-essential pkg-config cmake g++ gcc git \
                libssl-dev libgnutls28-dev default-libmysqlclient-dev \
                uuid-dev libncurses-dev libicu-dev libevent-dev \
                ca-certificates automake autoconf libtool bzip2 python3 \
                equivs dpkg-dev

              VERSION="${{ env.PROXYSQL_VERSION }}"
              VERSION="${VERSION#v}"

              git clone --depth 1 --branch ${{ env.PROXYSQL_VERSION }} \
                https://github.com/sysown/proxysql.git /build/proxysql
              cd /build/proxysql
              sed -i "/targets += coredumper/d" deps/Makefile
              sed -i "/IDIRS.*COREDUMPER/d" lib/Makefile
              sed -i "/LDIRS.*COREDUMPER/d" src/Makefile
              sed -i "/lcoredumper/d" src/Makefile
              make -j$(nproc)

              # Package as .deb using equivs
              mkdir -p /build/pkg/usr/bin
              cp src/proxysql /build/pkg/usr/bin/proxysql
              chmod 755 /build/pkg/usr/bin/proxysql

              {
                echo "Section: database"
                echo "Priority: optional"
                echo "Standards-Version: 4.6.2"
                echo "Package: proxysql"
                echo "Version: ${VERSION}-1"
                echo "Maintainer: Kolla ppc64le <kolla-ppc64le@noreply.github.com>"
                echo "Architecture: ppc64el"
                echo "Depends: libgnutls30t64, libmariadb3, libunwind8"
                echo "Description: ProxySQL for ppc64le"
                echo " Pre-built ProxySQL binary packaged for Kolla ppc64le builds."
              } > /build/pkg/proxysql.ctl

              cd /build/pkg
              equivs-build proxysql.ctl
              cp proxysql_*.deb /output/
            '
          ls -la proxysql-deb/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: proxysql-deb
          path: proxysql-deb/*.deb
          retention-days: 5

  build-grpcio:
    runs-on: ubuntu-latest
    steps:
      - name: Cache grpcio wheel
        id: cache
        uses: actions/cache@v4
        with:
          path: grpcio-wheel
          key: grpcio-ppc64le-${{ env.GRPCIO_VERSION }}-cp313

      - name: Cross-compile grpcio for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p grpcio-wheel
          docker run --rm \
            -v "${{ github.workspace }}/grpcio-wheel:/output" \
            debian:trixie \
            bash -c '
              set -ex
              dpkg --add-architecture ppc64el
              apt-get update && apt-get install -y --no-install-recommends \
                python3-dev python3-pip python3-venv build-essential \
                crossbuild-essential-ppc64el \
                libpython3.13-dev:ppc64el

              pip download --no-binary :all: --no-deps grpcio==${{ env.GRPCIO_VERSION }}
              tar xzf grpcio-*.tar.gz
              cd grpcio-*/

              sed -i "/#elif defined(__myriad2__)/{N;s/#define OPENSSL_32_BIT/#define OPENSSL_32_BIT\n#elif defined(__PPC64__)\n#define OPENSSL_64_BIT\n#elif defined(__PPC__)\n#define OPENSSL_32_BIT/}" \
                third_party/boringssl-with-bazel/src/include/openssl/target.h

              CC=powerpc64le-linux-gnu-gcc \
              CXX=powerpc64le-linux-gnu-g++ \
              _PYTHON_HOST_PLATFORM=linux-ppc64le \
              pip wheel --no-cache-dir --no-deps \
                --wheel-dir=/output .
            '
          ls -la grpcio-wheel/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: grpcio-wheel
          path: grpcio-wheel/*.whl
          retention-days: 5

  build-crypto-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Cache Python wheels
        id: cache
        uses: actions/cache@v4
        with:
          path: crypto-wheels
          key: crypto-wheels-ppc64le-crypto${{ env.CRYPTOGRAPHY_VERSION }}-bcrypt${{ env.BCRYPT_VERSION }}-cp313

      - name: Set up QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/ppc64le

      - name: Build cryptography and bcrypt wheels for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p crypto-wheels
          docker run --rm --platform linux/ppc64le \
            -v "${{ github.workspace }}/crypto-wheels:/output" \
            debian:trixie \
            bash -c '
              set -ex
              apt-get update && apt-get install -y --no-install-recommends \
                python3-dev python3-pip python3-venv build-essential \
                rustc cargo libssl-dev libffi-dev pkg-config
              pip wheel --no-cache-dir --no-deps \
                --wheel-dir=/output \
                cryptography==${{ env.CRYPTOGRAPHY_VERSION }} \
                bcrypt==${{ env.BCRYPT_VERSION }}
            '
          ls -la crypto-wheels/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: crypto-wheels
          path: crypto-wheels/*.whl
          retention-days: 5

  build-manylinux-wheel:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - pip_name: pyyaml
            pip_pkg: PyYAML
            version: '6.0.2'
            yum_deps: 'libyaml-devel'
          - pip_name: markupsafe
            pip_pkg: MarkupSafe
            version: '3.0.2'
            yum_deps: ''
          - pip_name: msgpack
            pip_pkg: msgpack
            version: '1.1.1'
            yum_deps: ''
          - pip_name: wrapt
            pip_pkg: wrapt
            version: '1.17.2'
            yum_deps: ''
          - pip_name: psutil
            pip_pkg: psutil
            version: '7.0.0'
            yum_deps: ''
          - pip_name: pyrsistent
            pip_pkg: pyrsistent
            version: '0.20.0'
            yum_deps: ''
          - pip_name: netifaces
            pip_pkg: netifaces
            version: '0.11.0'
            yum_deps: ''
          - pip_name: tornado
            pip_pkg: tornado
            version: '6.5.1'
            yum_deps: ''
          - pip_name: sysv-ipc
            pip_pkg: sysv_ipc
            version: '1.1.0'
            yum_deps: ''
          - pip_name: ujson
            pip_pkg: ujson
            version: '5.10.0'
            yum_deps: ''
          - pip_name: pillow
            pip_pkg: pillow
            version: '11.3.0'
            yum_deps: 'libjpeg-turbo-devel zlib-devel libtiff-devel freetype-devel lcms2-devel libwebp-devel'
          - pip_name: psycopg2
            pip_pkg: psycopg2
            version: '2.9.10'
            yum_deps: 'postgresql-devel'
    steps:
      - name: Cache ${{ matrix.pip_name }} wheel
        id: cache
        uses: actions/cache@v4
        with:
          path: wheel-output
          key: ${{ matrix.pip_name }}-ppc64le-${{ matrix.version }}-cp313-manylinux_2_28

      - name: Set up QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/ppc64le

      - name: Build ${{ matrix.pip_name }} wheel for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p wheel-output
          docker run --rm --platform linux/ppc64le \
            -v "${{ github.workspace }}/wheel-output:/output" \
            quay.io/pypa/manylinux_2_28_ppc64le \
            bash -c '
              set -ex
              if [ -n "${{ matrix.yum_deps }}" ]; then
                yum install -y ${{ matrix.yum_deps }}
              fi
              PYTHON=/opt/python/cp313-cp313/bin/python3
              $PYTHON -m pip wheel --no-cache-dir --no-deps \
                --wheel-dir=/tmp/wheels \
                ${{ matrix.pip_pkg }}==${{ matrix.version }}
              for whl in /tmp/wheels/*.whl; do
                auditwheel repair "$whl" \
                  --plat manylinux_2_28_ppc64le \
                  --wheel-dir=/output || cp "$whl" /output/
              done
            '
          ls -la wheel-output/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.pip_name }}-wheel
          path: wheel-output/*.whl
          retention-days: 5

  build-pynacl-wheel:
    runs-on: ubuntu-latest
    steps:
      - name: Cache PyNaCl wheel
        id: cache
        uses: actions/cache@v4
        with:
          path: pynacl-wheel
          key: pynacl-ppc64le-${{ env.PYNACL_VERSION }}-cp313

      - name: Cross-compile PyNaCl for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p pynacl-wheel
          docker run --rm \
            -v "${{ github.workspace }}/pynacl-wheel:/output" \
            debian:trixie \
            bash -c '
              set -ex
              dpkg --add-architecture ppc64el
              apt-get update && apt-get install -y --no-install-recommends \
                python3-dev python3-pip python3-venv build-essential \
                crossbuild-essential-ppc64el \
                libpython3.13-dev:ppc64el libffi-dev libffi-dev:ppc64el

              python3 -m venv /tmp/bv
              /tmp/bv/bin/pip install --no-cache-dir cffi setuptools wheel

              /tmp/bv/bin/pip download --no-binary :all: --no-deps \
                "PyNaCl==${{ env.PYNACL_VERSION }}"
              tar xzf PyNaCl-*.tar.gz
              cd PyNaCl-*/

              # Phase 1: Cross-compile bundled libsodium with proper --host
              cd src/libsodium
              chmod +x configure autogen.sh compile depcomp install-sh missing
              ./configure \
                --host=powerpc64le-linux-gnu \
                --disable-shared --enable-static \
                --disable-debug --disable-dependency-tracking \
                --with-pic \
                --prefix=/tmp/libsodium-ppc64le
              make -j$(nproc)
              make install
              cd ../..

              # Phase 2: Build PyNaCl against pre-built libsodium
              SODIUM_INSTALL=system \
              CFLAGS="-I/tmp/libsodium-ppc64le/include" \
              LDFLAGS="-L/tmp/libsodium-ppc64le/lib" \
              CC=powerpc64le-linux-gnu-gcc \
              _PYTHON_HOST_PLATFORM=linux-ppc64le \
              /tmp/bv/bin/pip wheel --no-cache-dir --no-deps --no-build-isolation \
                --wheel-dir=/output .
            '
          ls -la pynacl-wheel/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pynacl-wheel
          path: pynacl-wheel/*.whl
          retention-days: 5

  build-uwsgi-proton-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Cache uwsgi and proton wheels
        id: cache
        uses: actions/cache@v4
        with:
          path: uwsgi-proton-wheels
          key: uwsgi-proton-ppc64le-uwsgi${{ env.UWSGI_VERSION }}-proton${{ env.PROTON_VERSION }}-cp313

      - name: Set up QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/ppc64le

      - name: Build uwsgi and python-qpid-proton wheels for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p uwsgi-proton-wheels
          docker run --rm --platform linux/ppc64le \
            -v "${{ github.workspace }}/uwsgi-proton-wheels:/output" \
            debian:trixie \
            bash -c '
              set -ex
              apt-get update && apt-get install -y --no-install-recommends \
                python3-dev python3-pip build-essential pkg-config \
                libpcre2-dev libssl-dev libcap-dev libyaml-dev libjansson-dev \
                cmake swig libqpid-proton11-dev
              pip wheel --no-cache-dir --no-deps \
                --wheel-dir=/output \
                uwsgi==${{ env.UWSGI_VERSION }} \
                python-qpid-proton==${{ env.PROTON_VERSION }}
            '
          ls -la uwsgi-proton-wheels/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: uwsgi-proton-wheels
          path: uwsgi-proton-wheels/*.whl
          retention-days: 5

  build-py-radix-wheel:
    runs-on: ubuntu-latest
    steps:
      - name: Cache py-radix wheel
        id: cache
        uses: actions/cache@v4
        with:
          path: py-radix-wheel
          key: py-radix-ppc64le-${{ env.PYRADIX_VERSION }}-cp313-cross

      - name: Cross-compile py-radix for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p py-radix-wheel
          docker run --rm \
            -v "${{ github.workspace }}/py-radix-wheel:/output" \
            debian:trixie \
            bash -c '
              set -ex
              dpkg --add-architecture ppc64el
              apt-get update && apt-get install -y --no-install-recommends \
                python3-dev python3-pip build-essential \
                crossbuild-essential-ppc64el \
                libpython3.13-dev:ppc64el

              python3 -c "import json,urllib.request;d=json.loads(urllib.request.urlopen(\"https://pypi.org/pypi/py-radix/${{ env.PYRADIX_VERSION }}/json\").read());s=next(u for u in d[\"urls\"] if u[\"packagetype\"]==\"sdist\");urllib.request.urlretrieve(s[\"url\"],\"/tmp/\"+s[\"filename\"])"
              tar xzf /tmp/py_radix-*.tar.gz -C /tmp/
              cd /tmp/py_radix-*/

              CC=powerpc64le-linux-gnu-gcc \
              CFLAGS="-Wno-error=incompatible-pointer-types" \
              _PYTHON_HOST_PLATFORM=linux-ppc64le \
              pip wheel --no-cache-dir --no-deps \
                --wheel-dir=/output .
            '
          ls -la py-radix-wheel/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: py-radix-wheel
          path: py-radix-wheel/*.whl
          retention-days: 5

  build-cross-compiled-wheels:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - pip_name: libsass
            pip_pkg: libsass
            version: '0.23.0'
            apt_deps: ''
            extra_env: ''
          - pip_name: zstd
            pip_pkg: zstd
            version: '1.5.7.2'
            apt_deps: ''
            extra_env: ''
          - pip_name: lz4
            pip_pkg: lz4
            version: '4.4.5'
            apt_deps: ''
            extra_env: ''
          - pip_name: ruamel-yaml-clib
            pip_pkg: ruamel.yaml.clib
            version: '0.2.12'
            apt_deps: ''
            extra_env: ''
          - pip_name: yappi
            pip_pkg: yappi
            version: '1.6.10'
            apt_deps: ''
            extra_env: ''
          - pip_name: python-ldap
            pip_pkg: python-ldap
            version: '3.4.4'
            apt_deps: 'libldap2-dev:ppc64el libsasl2-dev:ppc64el'
            extra_env: ''
          - pip_name: scrypt
            pip_pkg: scrypt
            version: '0.8.27'
            apt_deps: 'libssl-dev:ppc64el'
            extra_env: ''
          - pip_name: rcssmin
            pip_pkg: rcssmin
            version: '1.1.2'
            apt_deps: ''
            extra_env: ''
          - pip_name: rjsmin
            pip_pkg: rjsmin
            version: '1.2.2'
            apt_deps: ''
            extra_env: ''
          - pip_name: zeroconf
            pip_pkg: zeroconf
            version: '0.147.0'
            apt_deps: ''
            extra_env: ''
          - pip_name: gssapi
            pip_pkg: gssapi
            version: '1.9.0'
            apt_deps: 'libkrb5-dev:ppc64el'
            extra_env: 'GSSAPI_SUPPORT_DETECT=false GSSAPI_COMPILER_ARGS="-I/usr/include" GSSAPI_LINKER_ARGS="-L/usr/lib/powerpc64le-linux-gnu -lgssapi_krb5"'
          - pip_name: krb5
            pip_pkg: krb5
            version: '0.7.1'
            apt_deps: 'libkrb5-dev:ppc64el libkrb5-3'
            extra_env: 'KRB5_MAIN_LIB=/usr/lib/x86_64-linux-gnu/libkrb5.so.3 KRB5_COMPILER_ARGS="-I/usr/include" KRB5_LINKER_ARGS="-L/usr/lib/powerpc64le-linux-gnu -lkrb5 -lk5crypto -lcom_err"'
    steps:
      - name: Cache ${{ matrix.pip_name }} wheel
        id: cache
        uses: actions/cache@v4
        with:
          path: wheel-output
          key: ${{ matrix.pip_name }}-ppc64le-${{ matrix.version }}-cp313-cross

      - name: Cross-compile ${{ matrix.pip_name }} for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p wheel-output
          docker run --rm \
            -v "${{ github.workspace }}/wheel-output:/output" \
            debian:trixie \
            bash -c '
              set -ex
              dpkg --add-architecture ppc64el
              apt-get update && apt-get install -y --no-install-recommends \
                python3-dev python3-pip python3-venv build-essential \
                crossbuild-essential-ppc64el \
                libpython3.13-dev:ppc64el ${{ matrix.apt_deps }}

              ${{ matrix.extra_env }} \
              CC=powerpc64le-linux-gnu-gcc \
              CXX=powerpc64le-linux-gnu-g++ \
              _PYTHON_HOST_PLATFORM=linux-ppc64le \
              pip wheel --no-cache-dir --no-deps \
                --wheel-dir=/output \
                ${{ matrix.pip_pkg }}==${{ matrix.version }}
            '
          ls -la wheel-output/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.pip_name }}-wheel
          path: wheel-output/*.whl
          retention-days: 5

  build-numpy-wheel:
    runs-on: ubuntu-latest
    steps:
      - name: Cache numpy wheel
        id: cache
        uses: actions/cache@v4
        with:
          path: numpy-wheel
          key: numpy-ppc64le-${{ env.NUMPY_VERSION }}-cp313

      - name: Set up QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/ppc64le

      - name: Build numpy wheel for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p numpy-wheel
          docker run --rm --platform linux/ppc64le \
            -v "${{ github.workspace }}/numpy-wheel:/output" \
            debian:trixie \
            bash -c '
              set -ex
              apt-get update && apt-get install -y --no-install-recommends \
                python3-dev python3-pip python3-venv build-essential \
                pkg-config libopenblas-dev gfortran
              pip wheel --no-cache-dir --no-deps \
                --wheel-dir=/output \
                numpy==${{ env.NUMPY_VERSION }}
            '
          ls -la numpy-wheel/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: numpy-wheel
          path: numpy-wheel/*.whl
          retention-days: 5

  build-pyzmq-wheel:
    runs-on: ubuntu-latest
    steps:
      - name: Cache pyzmq wheel
        id: cache
        uses: actions/cache@v4
        with:
          path: pyzmq-wheel
          key: pyzmq-ppc64le-${{ env.PYZMQ_VERSION }}-cp313

      - name: Set up QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/ppc64le

      - name: Build pyzmq wheel for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p pyzmq-wheel
          docker run --rm --platform linux/ppc64le \
            -v "${{ github.workspace }}/pyzmq-wheel:/output" \
            debian:trixie \
            bash -c '
              set -ex
              apt-get update && apt-get install -y --no-install-recommends \
                python3-dev python3-pip python3-venv build-essential \
                pkg-config cmake
              pip wheel --no-cache-dir --no-deps \
                --wheel-dir=/output \
                pyzmq==${{ env.PYZMQ_VERSION }}
            '
          ls -la pyzmq-wheel/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pyzmq-wheel
          path: pyzmq-wheel/*.whl
          retention-days: 5

  build-magnum-cluster-api-wheel:
    runs-on: ubuntu-latest
    steps:
      - name: Cache magnum-cluster-api wheel
        id: cache
        uses: actions/cache@v4
        with:
          path: magnum-cluster-api-wheel
          key: magnum-cluster-api-ppc64le-${{ env.MAGNUM_CLUSTER_API_VERSION }}-cp313

      - name: Cross-compile magnum-cluster-api for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p magnum-cluster-api-wheel
          docker run --rm \
            -v "${{ github.workspace }}/magnum-cluster-api-wheel:/output" \
            debian:trixie \
            bash -c '
              set -ex
              dpkg --add-architecture ppc64el
              apt-get update && apt-get install -y --no-install-recommends \
                python3-dev python3-pip python3-venv build-essential \
                crossbuild-essential-ppc64el \
                libpython3.13-dev:ppc64el \
                libpython3.13-stdlib:ppc64el \
                curl pkg-config

              cp /usr/lib/python3.13/_sysconfigdata__linux_powerpc64le-linux-gnu.py \
                /usr/lib/powerpc64le-linux-gnu/

              curl --proto =https --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              . $HOME/.cargo/env
              rustup target add powerpc64le-unknown-linux-gnu

              python3 -m venv /tmp/build-venv
              . /tmp/build-venv/bin/activate
              pip install --no-cache-dir maturin

              CARGO_BUILD_TARGET=powerpc64le-unknown-linux-gnu \
              CARGO_TARGET_POWERPC64LE_UNKNOWN_LINUX_GNU_LINKER=powerpc64le-linux-gnu-gcc \
              PYO3_CROSS_LIB_DIR=/usr/lib/powerpc64le-linux-gnu/ \
              PYO3_CROSS_PYTHON_VERSION=3.13 \
              _PYTHON_SYSCONFIGDATA_NAME=_sysconfigdata__linux_powerpc64le-linux-gnu \
              CC=powerpc64le-linux-gnu-gcc \
              CXX=powerpc64le-linux-gnu-g++ \
              _PYTHON_HOST_PLATFORM=linux-ppc64le \
              pip wheel --no-cache-dir --no-deps --no-build-isolation \
                --wheel-dir=/output \
                magnum-cluster-api==${{ env.MAGNUM_CLUSTER_API_VERSION }}
            '
          ls -la magnum-cluster-api-wheel/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: magnum-cluster-api-wheel
          path: magnum-cluster-api-wheel/*.whl
          retention-days: 5

  build-lego:
    runs-on: ubuntu-latest
    steps:
      - name: Cache lego binary
        id: cache
        uses: actions/cache@v4
        with:
          path: lego-binary
          key: lego-ppc64le-${{ env.LEGO_VERSION }}

      - name: Cross-compile lego for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p lego-binary
          docker run --rm \
            -v "${{ github.workspace }}/lego-binary:/output" \
            golang:1.25-trixie \
            bash -c '
              set -ex
              git clone --depth 1 --branch ${{ env.LEGO_VERSION }} \
                https://github.com/go-acme/lego.git /build/lego
              cd /build/lego
              CGO_ENABLED=0 GOOS=linux GOARCH=ppc64le go build -o /tmp/lego ./cmd/lego
              cd /output && tar czf lego_${{ env.LEGO_VERSION }}_linux_ppc64le.tar.gz -C /tmp lego
            '
          ls -la lego-binary/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lego-binary
          path: lego-binary/
          retention-days: 5

  build-cadvisor:
    runs-on: ubuntu-latest
    steps:
      - name: Cache cadvisor binary
        id: cache
        uses: actions/cache@v4
        with:
          path: cadvisor-binary
          key: cadvisor-ppc64le-${{ env.CADVISOR_VERSION }}

      - name: Cross-compile cadvisor for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p cadvisor-binary
          docker run --rm \
            -v "${{ github.workspace }}/cadvisor-binary:/output" \
            golang:1.25-trixie \
            bash -c '
              set -ex
              git clone --depth 1 --branch ${{ env.CADVISOR_VERSION }} \
                https://github.com/google/cadvisor.git /build/cadvisor
              cd /build/cadvisor/cmd
              CGO_ENABLED=0 GOOS=linux GOARCH=ppc64le go build -o /output/cadvisor-${{ env.CADVISOR_VERSION }}-linux-ppc64le .
            '
          ls -la cadvisor-binary/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cadvisor-binary
          path: cadvisor-binary/
          retention-days: 5

  build-openstack-exporter:
    runs-on: ubuntu-latest
    steps:
      - name: Cache openstack-exporter binary
        id: cache
        uses: actions/cache@v4
        with:
          path: openstack-exporter-binary
          key: osexp-ppc64le-${{ env.OPENSTACK_EXPORTER_VERSION }}

      - name: Cross-compile openstack-exporter for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p openstack-exporter-binary
          docker run --rm \
            -v "${{ github.workspace }}/openstack-exporter-binary:/output" \
            golang:1.25-trixie \
            bash -c '
              set -ex
              OSEXP_VERSION="${{ env.OPENSTACK_EXPORTER_VERSION }}"
              OSEXP_VERSION_BARE="${OSEXP_VERSION#v}"
              git clone --depth 1 --branch ${OSEXP_VERSION} \
                https://github.com/openstack-exporter/openstack-exporter.git /build/openstack-exporter
              cd /build/openstack-exporter
              CGO_ENABLED=0 GOOS=linux GOARCH=ppc64le go build -o /tmp/openstack-exporter .
              cd /output && tar czf openstack-exporter_${OSEXP_VERSION_BARE}_linux_ppc64le.tar.gz -C /tmp openstack-exporter
            '
          ls -la openstack-exporter-binary/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openstack-exporter-binary
          path: openstack-exporter-binary/
          retention-days: 5

  build-mtail:
    runs-on: ubuntu-latest
    steps:
      - name: Cache mtail binary
        id: cache
        uses: actions/cache@v4
        with:
          path: mtail-binary
          key: mtail-ppc64le-${{ env.MTAIL_VERSION }}

      - name: Cross-compile mtail for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p mtail-binary
          docker run --rm \
            -v "${{ github.workspace }}/mtail-binary:/output" \
            golang:1.25-trixie \
            bash -c '
              set -ex
              MTAIL_VERSION="${{ env.MTAIL_VERSION }}"
              MTAIL_VERSION_BARE="${MTAIL_VERSION#v}"
              git clone --depth 1 --branch ${MTAIL_VERSION} \
                https://github.com/google/mtail.git /build/mtail
              cd /build/mtail
              CGO_ENABLED=0 GOOS=linux GOARCH=ppc64le go build -o /tmp/mtail ./cmd/mtail
              cd /output && tar czf mtail_${MTAIL_VERSION_BARE}_linux_ppc64le.tar.gz -C /tmp mtail
            '
          ls -la mtail-binary/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mtail-binary
          path: mtail-binary/
          retention-days: 5

  build-libvirt-exporter:
    runs-on: ubuntu-latest
    steps:
      - name: Cache libvirt-exporter binary
        id: cache
        uses: actions/cache@v4
        with:
          path: libvirt-exporter-binary
          key: libvirtexp-ppc64le-${{ env.LIBVIRT_EXPORTER_VERSION }}

      - name: Cross-compile prometheus-libvirt-exporter for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p libvirt-exporter-binary
          docker run --rm \
            -v "${{ github.workspace }}/libvirt-exporter-binary:/output" \
            golang:1.25-trixie \
            bash -c '
              set -ex
              LIBVIRT_VERSION="${{ env.LIBVIRT_EXPORTER_VERSION }}"
              LIBVIRT_VERSION_BARE="${LIBVIRT_VERSION#v}"
              git clone --depth 1 --branch ${LIBVIRT_VERSION} \
                https://github.com/inovex/prometheus-libvirt-exporter.git /build/libvirt-exporter
              cd /build/libvirt-exporter
              DIRNAME="prometheus-libvirt-exporter-${LIBVIRT_VERSION_BARE}.linux-ppc64le"
              mkdir -p /tmp/${DIRNAME}
              CGO_ENABLED=0 GOOS=linux GOARCH=ppc64le go build -o /tmp/${DIRNAME}/prometheus-libvirt-exporter .
              cd /tmp && tar czf /output/${DIRNAME}.tar.gz ${DIRNAME}
            '
          ls -la libvirt-exporter-binary/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libvirt-exporter-binary
          path: libvirt-exporter-binary/
          retention-days: 5

  build-opflex:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, ppc64le]
    steps:
      - name: Cache OpFlex binaries
        id: cache
        uses: actions/cache@v4
        with:
          path: opflex-binaries
          key: opflex-${{ matrix.arch }}-${{ env.OPFLEX_VERSION }}-ovs${{ env.OVS_VERSION }}

      - name: Build OpFlex for ${{ matrix.arch }}
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p opflex-binaries
          docker run --rm \
            -v "${{ github.workspace }}/opflex-binaries:/output" \
            debian:trixie \
            bash -c '
              set -ex
              OVS_VERSION=${{ env.OVS_VERSION }}
              ARCH=${{ matrix.arch }}

              if [ "${ARCH}" = "ppc64le" ]; then
                dpkg --add-architecture ppc64el
                apt-get update && apt-get install -y --no-install-recommends \
                  build-essential crossbuild-essential-ppc64el \
                  autoconf automake libtool pkg-config cmake git ca-certificates \
                  default-jdk maven python3 \
                  libboost-dev libboost-system-dev libboost-filesystem-dev \
                  libboost-program-options-dev libboost-iostreams-dev \
                  libboost-test-dev libboost-date-time-dev \
                  libuv1-dev rapidjson-dev libssl-dev zlib1g-dev \
                  libunbound-dev libcap-ng-dev \
                  libboost-dev:ppc64el libboost-system-dev:ppc64el \
                  libboost-filesystem-dev:ppc64el libboost-program-options-dev:ppc64el \
                  libboost-iostreams-dev:ppc64el libboost-test-dev:ppc64el \
                  libboost-date-time-dev:ppc64el \
                  libuv1-dev:ppc64el libssl-dev:ppc64el zlib1g-dev:ppc64el \
                  libunbound-dev:ppc64el libcap-ng-dev:ppc64el
                CC=powerpc64le-linux-gnu-gcc
                CXX=powerpc64le-linux-gnu-g++
                HOST_FLAG="--host=powerpc64le-linux-gnu"
                CMAKE_EXTRA="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_SYSTEM_PROCESSOR=ppc64le"
                MULTIARCH_LIBDIR="/usr/lib/powerpc64le-linux-gnu"
              else
                apt-get update && apt-get install -y --no-install-recommends \
                  build-essential \
                  autoconf automake libtool pkg-config cmake git ca-certificates \
                  default-jdk maven python3 \
                  libboost-dev libboost-system-dev libboost-filesystem-dev \
                  libboost-program-options-dev libboost-iostreams-dev \
                  libboost-test-dev libboost-date-time-dev \
                  libuv1-dev rapidjson-dev libssl-dev zlib1g-dev \
                  libunbound-dev libcap-ng-dev
                CC=gcc
                CXX=g++
                HOST_FLAG=""
                CMAKE_EXTRA=""
                MULTIARCH_LIBDIR=""
              fi

              git clone --depth 1 --branch v${OVS_VERSION} \
                https://github.com/openvswitch/ovs.git /build/ovs
              git clone --depth 1 --branch ${{ env.OPFLEX_VERSION }} \
                https://github.com/noironetworks/opflex.git /build/opflex
              git clone --depth 1 \
                https://github.com/noironetworks/3rdparty-debian.git /build/3rdparty-debian
              git clone --depth 1 -b v1.0.1 \
                https://github.com/jupp0r/prometheus-cpp.git /build/prometheus-cpp
              cd /build/prometheus-cpp && git submodule init && git submodule update
              git apply /build/3rdparty-debian/prometheus/prometheus-cpp.patch

              find /build/opflex/agent-ovs -name "*.cpp" -o -name "*.h" | \
                xargs sed -i "s/OFPCR12_ROLE_MASTER/OFPCR12_ROLE_PRIMARY/g; s/OFPCR12_ROLE_SLAVE/OFPCR12_ROLE_SECONDARY/g"

              cd /build/ovs && ./boot.sh
              cd /build/opflex/libopflex && ./autogen.sh
              cd /build/opflex/agent-ovs && ./autogen.sh
              cd /build/opflex/genie && mvn compile exec:java
              cd /build/opflex/genie/target/libmodelgbp && bash autogen.sh

              STAGE=/build/staging
              mkdir -p ${STAGE}

              cd /build/ovs
              ./configure --prefix=/usr/local --with-pic ${HOST_FLAG} CC=${CC} CXX=${CXX}
              make -j$(nproc)
              make DESTDIR=${STAGE} install
              ln -sfn /build/ovs/lib /build/ovs/include/openvswitch/lib
              rm -f /build/ovs/lib/string.h /build/ovs/lib/stdio.h

              cd /build/opflex/libopflex
              PKG_CONFIG_PATH="${STAGE}/usr/local/lib/pkgconfig" \
              LDFLAGS="-L${STAGE}/usr/local/lib" \
              CPPFLAGS="-I${STAGE}/usr/local/include" \
              ./configure --prefix=/usr/local ${HOST_FLAG} ${MULTIARCH_LIBDIR:+--with-boost-libdir=${MULTIARCH_LIBDIR}} CC=${CC} CXX=${CXX}
              make -j$(nproc)
              make DESTDIR=${STAGE} install

              cd /build/opflex/genie/target/libmodelgbp
              PKG_CONFIG_PATH="${STAGE}/usr/local/lib/pkgconfig" \
              LDFLAGS="-L${STAGE}/usr/local/lib" \
              CPPFLAGS="-I${STAGE}/usr/local/include" \
              ./configure --prefix=/usr/local --disable-static ${HOST_FLAG} ${MULTIARCH_LIBDIR:+--with-boost-libdir=${MULTIARCH_LIBDIR}} CC=${CC} CXX=${CXX}
              make -j$(nproc)
              make DESTDIR=${STAGE} install

              cd /build/prometheus-cpp
              mkdir _build && cd _build
              cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local \
                -DCMAKE_C_COMPILER=${CC} -DCMAKE_CXX_COMPILER=${CXX} \
                ${CMAKE_EXTRA} -DBUILD_SHARED_LIBS=ON -DENABLE_PUSH=OFF
              make -j$(nproc)
              make DESTDIR=${STAGE} install

              sed -i "s|/usr/local/lib|${STAGE}/usr/local/lib|g" ${STAGE}/usr/local/lib/*.la

              cd /build/opflex/agent-ovs
              PKG_CONFIG_PATH="${STAGE}/usr/local/lib/pkgconfig" \
              LDFLAGS="-L${STAGE}/usr/local/lib" \
              CPPFLAGS="-isystem /build/ovs/include -isystem /build/ovs/lib -isystem /build/ovs/include/openvswitch -I${STAGE}/usr/local/include" \
              CXXFLAGS="-g -O2 -Wno-error=dangling-reference" \
              LIBS="-lopenvswitch" \
              ./configure --prefix=/usr/local ${HOST_FLAG} ${MULTIARCH_LIBDIR:+--with-boost-libdir=${MULTIARCH_LIBDIR}} CC=${CC} CXX=${CXX}
              make -j$(nproc)
              make DESTDIR=${STAGE} install

              find ${STAGE}/usr/local/lib -name "*.a" -delete
              find ${STAGE}/usr/local/lib -name "*.la" -delete
              rm -rf ${STAGE}/usr/local/include ${STAGE}/usr/local/share \
                ${STAGE}/usr/local/lib/pkgconfig
              rm -f ${STAGE}/usr/local/bin/ovs-* ${STAGE}/usr/local/bin/ovsdb-*
              rm -rf ${STAGE}/usr/local/sbin ${STAGE}/usr/local/var \
                ${STAGE}/usr/local/etc

              cd ${STAGE}
              tar czf /output/opflex-binaries-${ARCH}.tar.gz usr/local
            '
          ls -la opflex-binaries/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opflex-binaries-${{ matrix.arch }}
          path: opflex-binaries/*.tar.gz
          retention-days: 5

  build-fluent-package:
    runs-on: ubuntu-latest
    steps:
      - name: Cache fluent-package deb
        id: cache
        uses: actions/cache@v4
        with:
          path: fluent-package-deb
          key: fluent-package-ppc64le-${{ env.FLUENT_PACKAGE_VERSION }}-deb

      - name: Set up QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/ppc64le

      - uses: ruby/setup-ruby@v1
        if: steps.cache.outputs.cache-hit != 'true'
        with:
          ruby-version: '3.4'

      - name: Build fluent-package for ppc64le
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          DOCKER_DEFAULT_PLATFORM: linux/ppc64le
        run: |
          git clone --depth 1 --branch ${{ env.FLUENT_PACKAGE_VERSION }} \
            https://github.com/fluent/fluent-package-builder.git
          cd fluent-package-builder
          mkdir -p fluent-package/apt/debian-trixie-ppc64le
          echo "debian:trixie" > fluent-package/apt/debian-trixie-ppc64le/from
          rake apt:build APT_TARGETS="debian-trixie-ppc64le"
          mkdir -p ${{ github.workspace }}/fluent-package-deb
          find fluent-package/apt/repositories -name "fluent-package*.deb" \
            -exec cp {} ${{ github.workspace }}/fluent-package-deb/ \;

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fluent-package-deb
          path: fluent-package-deb/*.deb
          retention-days: 5

  build-opensearch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout kolla (for patch file)
        uses: actions/checkout@v4

      - name: Cache OpenSearch deb
        id: cache
        uses: actions/cache@v4
        with:
          path: opensearch-deb
          key: opensearch-ppc64le-${{ env.OPENSEARCH_VERSION }}-deb

      - name: Build OpenSearch ppc64le deb
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p opensearch-deb
          docker run --rm \
            -v "${{ github.workspace }}/opensearch-deb:/output" \
            -v "${{ github.workspace }}/docker/opensearch/opensearch/opensearch-ppc64le-deb.patch:/patch/opensearch-ppc64le-deb.patch" \
            eclipse-temurin:21-jdk \
            bash -c '
              set -ex
              apt-get update && apt-get install -y --no-install-recommends git ca-certificates
              git clone --depth 1 --branch ${{ env.OPENSEARCH_VERSION }} \
                https://github.com/opensearch-project/OpenSearch.git /build/OpenSearch
              cd /build/OpenSearch
              git apply /patch/opensearch-ppc64le-deb.patch
              ./gradlew :distribution:packages:buildNoJdkPpc64leDeb \
                -Dbuild.snapshot=false
              find distribution/packages -name "opensearch-min*.deb" \
                -exec cp {} /output/ \;
            '
          ls -la opensearch-deb/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opensearch-deb
          path: opensearch-deb/*.deb
          retention-days: 5

  publish:
    needs:
      - build-proxysql
      - build-grpcio
      - build-crypto-wheels
      - build-manylinux-wheel
      - build-pynacl-wheel
      - build-uwsgi-proton-wheels
      - build-py-radix-wheel
      - build-cross-compiled-wheels
      - build-numpy-wheel
      - build-pyzmq-wheel
      - build-magnum-cluster-api-wheel
      - build-lego
      - build-cadvisor
      - build-openstack-exporter
      - build-mtail
      - build-libvirt-exporter
      - build-opflex
      - build-fluent-package
      - build-opensearch
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Build Pages directory
        run: |
          set -ex
          SITE=site
          mkdir -p $SITE/ppc64le/apt $SITE/ppc64le/simple $SITE/ppc64le/tarballs

          cp docker/base/kolla-ppc64le-repo-key.asc $SITE/ppc64le/repo-key.asc

          # --- apt repo ---
          cp artifacts/proxysql-deb/*.deb $SITE/ppc64le/apt/
          cp artifacts/fluent-package-deb/*.deb $SITE/ppc64le/apt/
          cp artifacts/opensearch-deb/*.deb $SITE/ppc64le/apt/
          cd $SITE/ppc64le/apt
          dpkg-scanpackages . /dev/null > Packages
          gzip -k Packages
          apt-ftparchive release . > Release
          cd ${{ github.workspace }}

          # GPG sign
          echo "${{ secrets.PPC64LE_REPO_GPG_PRIVATE_KEY }}" | base64 -d | gpg --batch --import
          gpg --batch --yes --clearsign -o $SITE/ppc64le/apt/InRelease $SITE/ppc64le/apt/Release

          # --- pip index ---
          generate_pip_index() {
            local pkg_name=$1
            local pkg_dir=$SITE/ppc64le/simple/$pkg_name
            mkdir -p "$pkg_dir"
            local index="$pkg_dir/index.html"
            echo "<!DOCTYPE html><html><body>" > "$index"
            for whl in "$pkg_dir"/*.whl; do
              [ -f "$whl" ] || continue
              local fname=$(basename "$whl")
              local sha=$(sha256sum "$whl" | cut -d' ' -f1)
              echo "<a href=\"${fname}#sha256=${sha}\">${fname}</a><br/>" >> "$index"
            done
            echo "</body></html>" >> "$index"
          }

          # cryptography + bcrypt (multi-wheel artifact, needs filename-based routing)
          for pkg in cryptography bcrypt; do
            mkdir -p $SITE/ppc64le/simple/$pkg
          done
          for whl in artifacts/crypto-wheels/*.whl; do
            [ -f "$whl" ] || continue
            fname=$(basename "$whl")
            pkg_name=$(echo "$fname" | cut -d'-' -f1 | tr '[:upper:]' '[:lower:]')
            cp "$whl" "$SITE/ppc64le/simple/$pkg_name/"
          done
          generate_pip_index cryptography
          generate_pip_index bcrypt

          # uwsgi + python-qpid-proton (multi-wheel artifact, needs filename-based routing)
          for pkg in uwsgi python-qpid-proton; do
            mkdir -p "$SITE/ppc64le/simple/$pkg"
          done
          for whl in artifacts/uwsgi-proton-wheels/*.whl; do
            [ -f "$whl" ] || continue
            fname=$(basename "$whl")
            pkg_name=$(echo "$fname" | cut -d'-' -f1 | tr '[:upper:]' '[:lower:]' | sed 's/_/-/g')
            mkdir -p "$SITE/ppc64le/simple/$pkg_name"
            cp "$whl" "$SITE/ppc64le/simple/$pkg_name/"
          done
          generate_pip_index uwsgi
          generate_pip_index python-qpid-proton

          # Per-package artifacts (manylinux, cross-compiled, and standalone wheel jobs)
          for pkg in pyyaml markupsafe msgpack wrapt psutil pyrsistent netifaces tornado sysv-ipc ujson \
                     pillow psycopg2 grpcio pynacl py-radix numpy pyzmq \
                     libsass zstd lz4 ruamel-yaml-clib yappi \
                     python-ldap scrypt rcssmin rjsmin zeroconf gssapi krb5 magnum-cluster-api; do
            mkdir -p "$SITE/ppc64le/simple/$pkg"
            cp artifacts/${pkg}-wheel/*.whl "$SITE/ppc64le/simple/$pkg/" 2>/dev/null || true
            generate_pip_index "$pkg"
          done

          # Root index
          echo '<!DOCTYPE html><html><body>' > $SITE/ppc64le/simple/index.html
          for d in $SITE/ppc64le/simple/*/; do
            name=$(basename "$d")
            echo "<a href=\"${name}/\">${name}</a><br/>" >> $SITE/ppc64le/simple/index.html
          done
          echo '</body></html>' >> $SITE/ppc64le/simple/index.html

          # --- tarballs ---
          cp artifacts/opflex-binaries-*/*.tar.gz $SITE/ppc64le/tarballs/
          cp artifacts/lego-binary/* $SITE/ppc64le/tarballs/
          cp artifacts/cadvisor-binary/* $SITE/ppc64le/tarballs/
          cp artifacts/openstack-exporter-binary/* $SITE/ppc64le/tarballs/
          cp artifacts/mtail-binary/* $SITE/ppc64le/tarballs/
          cp artifacts/libvirt-exporter-binary/* $SITE/ppc64le/tarballs/

          echo "=== Pages site contents ==="
          find $SITE -type f | sort

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="ppc64le-deps/$(date +%Y%m%d)-${GITHUB_RUN_NUMBER}"
          BODY="ProxySQL ${{ env.PROXYSQL_VERSION }}, grpcio ${{ env.GRPCIO_VERSION }}, "
          BODY+="cryptography ${{ env.CRYPTOGRAPHY_VERSION }}, bcrypt ${{ env.BCRYPT_VERSION }}, "
          BODY+="OpFlex ${{ env.OPFLEX_VERSION }} (OVS ${{ env.OVS_VERSION }}), "
          BODY+="OpenSearch ${{ env.OPENSEARCH_VERSION }}, lego ${{ env.LEGO_VERSION }}, "
          BODY+="cadvisor ${{ env.CADVISOR_VERSION }}, openstack-exporter ${{ env.OPENSTACK_EXPORTER_VERSION }}, "
          BODY+="fluent-package ${{ env.FLUENT_PACKAGE_VERSION }}, "
          BODY+="mtail ${{ env.MTAIL_VERSION }}, libvirt-exporter ${{ env.LIBVIRT_EXPORTER_VERSION }}, "
          BODY+="pillow ${{ env.PILLOW_VERSION }}, py-radix ${{ env.PYRADIX_VERSION }}, "
          BODY+="PyYAML ${{ env.PYYAML_VERSION }}, MarkupSafe ${{ env.MARKUPSAFE_VERSION }}, "
          BODY+="msgpack ${{ env.MSGPACK_VERSION }}, wrapt ${{ env.WRAPT_VERSION }}, "
          BODY+="psutil ${{ env.PSUTIL_VERSION }}, pyrsistent ${{ env.PYRSISTENT_VERSION }}, "
          BODY+="netifaces ${{ env.NETIFACES_VERSION }}, PyNaCl ${{ env.PYNACL_VERSION }}, "
          BODY+="uwsgi ${{ env.UWSGI_VERSION }}, python-qpid-proton ${{ env.PROTON_VERSION }}, "
          BODY+="psycopg2 ${{ env.PSYCOPG2_VERSION }}, sysv_ipc ${{ env.SYSV_IPC_VERSION }}, "
          BODY+="tornado ${{ env.TORNADO_VERSION }}, ujson ${{ env.UJSON_VERSION }}, "
          BODY+="numpy ${{ env.NUMPY_VERSION }}, libsass ${{ env.LIBSASS_VERSION }}, "
          BODY+="zstd ${{ env.ZSTD_VERSION }}, lz4 ${{ env.LZ4_VERSION }}, "
          BODY+="pyzmq ${{ env.PYZMQ_VERSION }}, ruamel.yaml.clib ${{ env.RUAMEL_YAML_CLIB_VERSION }}, "
          BODY+="yappi ${{ env.YAPPI_VERSION }}, "
          BODY+="gssapi ${{ env.GSSAPI_VERSION }}, krb5 ${{ env.KRB5_VERSION }}, "
          BODY+="python-ldap ${{ env.PYTHON_LDAP_VERSION }}, scrypt ${{ env.SCRYPT_VERSION }}, "
          BODY+="rcssmin ${{ env.RCSSMIN_VERSION }}, rjsmin ${{ env.RJSMIN_VERSION }}, "
          BODY+="zeroconf ${{ env.ZEROCONF_VERSION }}, magnum-cluster-api ${{ env.MAGNUM_CLUSTER_API_VERSION }}"

          gh release create "$TAG" \
            --title "ppc64le deps $(date +%Y-%m-%d)" \
            --notes "$BODY" \
            artifacts/proxysql-deb/*.deb \
            artifacts/fluent-package-deb/*.deb \
            artifacts/opensearch-deb/*.deb \
            artifacts/grpcio-wheel/*.whl \
            artifacts/crypto-wheels/*.whl \
            artifacts/py-radix-wheel/*.whl \
            artifacts/pyyaml-wheel/*.whl \
            artifacts/markupsafe-wheel/*.whl \
            artifacts/msgpack-wheel/*.whl \
            artifacts/wrapt-wheel/*.whl \
            artifacts/psutil-wheel/*.whl \
            artifacts/pyrsistent-wheel/*.whl \
            artifacts/netifaces-wheel/*.whl \
            artifacts/tornado-wheel/*.whl \
            artifacts/sysv-ipc-wheel/*.whl \
            artifacts/ujson-wheel/*.whl \
            artifacts/pillow-wheel/*.whl \
            artifacts/pynacl-wheel/*.whl \
            artifacts/uwsgi-proton-wheels/*.whl \
            artifacts/psycopg2-wheel/*.whl \
            artifacts/libsass-wheel/*.whl \
            artifacts/zstd-wheel/*.whl \
            artifacts/lz4-wheel/*.whl \
            artifacts/ruamel-yaml-clib-wheel/*.whl \
            artifacts/yappi-wheel/*.whl \
            artifacts/numpy-wheel/*.whl \
            artifacts/pyzmq-wheel/*.whl \
            artifacts/python-ldap-wheel/*.whl \
            artifacts/scrypt-wheel/*.whl \
            artifacts/rcssmin-wheel/*.whl \
            artifacts/rjsmin-wheel/*.whl \
            artifacts/zeroconf-wheel/*.whl \
            artifacts/gssapi-wheel/*.whl \
            artifacts/krb5-wheel/*.whl \
            artifacts/magnum-cluster-api-wheel/*.whl \
            artifacts/lego-binary/* \
            artifacts/cadvisor-binary/* \
            artifacts/openstack-exporter-binary/* \
            artifacts/mtail-binary/* \
            artifacts/libvirt-exporter-binary/* \
            artifacts/opflex-binaries-*/*.tar.gz

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
